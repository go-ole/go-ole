name: Test

on: [pull_request, push, pull_request_target]

jobs:
  download:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: 'Checkout Project'
        uses: actions/checkout@v4

      - name: 'Download COM Test Release'
        uses: robinraju/release-downloader@v1
        with:
          repository: 'go-ole/test-com-server'
          latest: true
          fileName: 'test-com-server-x64.zip'
          zipBall: true
          extract: true
      - name: 'Register Assembly'
        run: 'c:\Windows\Microsoft.NET\Framework64\v4.0.30319\RegAsm.exe /codebase /nologo ${{ github.workspace }}\TestCOMServer.dll'

  build:
    runs-on: windows-latest
    permissions:
      contents: read
    strategy:
      matrix:
        go: [ '1.18', '1.23', 'stable' ]
    steps:
      - name: Setup go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          check-latest: true
      - name: 'Go Version'
        run: go version
      - name: 'Go Guild'
        run: go build
      - name: Run tests
        run: go test